<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† - AQRAB</title>
  <link rel="icon" type="image/x-icon" href="logo.ico">
   <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script>
    // Ø¥Ø®ÙØ§Ø¡ ØªØ­Ø°ÙŠØ±Ø§Øª Tailwind CSS ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    tailwind.config = {
      corePlugins: {
        preflight: false,
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- SheetJS library for Excel export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      font-family: 'Cairo', sans-serif;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    /* Loader Styles */
    .auth-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    .main-content {
      opacity: 0;
      transition: opacity 0.5s ease-in;
    }

    .main-content.show {
      opacity: 1;
    }

    .hidden {
      display: none !important;
    }


  </style>
</head>
<body class="bg-white text-black min-h-screen">

  <!-- Auth Loader -->
  <div id="authLoader" class="auth-loader">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <h2 class="text-white text-xl font-semibold mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</h2>
      <p class="text-white/80 text-sm">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
    </div>
  </div>



  <!-- Main Content -->
  <div id="mainContent" class="main-content">

  <!-- Header -->
  <header class="bg-gradient-to-r from-gray-900 to-black text-white shadow-2xl sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
            <i class="fa-solid fa-chart-line text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl lg:text-3xl font-bold">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… AQRAB</h1>
            <p class="text-gray-300 text-sm">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="notificationBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
            <i class="fa-solid fa-bell"></i>
            <span class="hidden lg:inline">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
          </button>
          <a href="index.html" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
            <i class="fa-solid fa-home"></i>
            <span class="hidden lg:inline">Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
          </a>
          <a href="coupons-admin.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
            <i class="fa-solid fa-ticket"></i>
            <span class="hidden lg:inline">Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</span>
          </a>
          <button id="returnsTab" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
            <i class="fa-solid fa-undo"></i>
            <span class="hidden lg:inline">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</span>
            <span id="returnsTabWarning" class="hidden ml-1 text-yellow-300">
              <i class="fa-solid fa-exclamation-triangle text-xs"></i>
            </span>
          </button>
          <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
            <i class="fa-solid fa-right-from-bracket"></i>
            <span class="hidden lg:inline">Ø®Ø±ÙˆØ¬</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
  <div id="permissionsAlert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mx-4 mt-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700">
          <strong>ØªØ­Ø°ÙŠØ±:</strong> Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø¨Ø³Ø¨Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Firebase.
          <span class="underline cursor-pointer" onclick="togglePermissionsHelp()">Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span>
        </p>
        <div id="permissionsHelp" class="hidden mt-2 text-xs text-yellow-600">
          <p>â€¢ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±: ØºÙŠØ± Ù…ØªØ§Ø­</p>
          <p>â€¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª: ØºÙŠØ± Ù…ØªØ§Ø­</p>
          <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore ÙÙŠ ÙˆØ­Ø¯Ø© ØªØ­ÙƒÙ… Firebase</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-10">

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ -->
    <div class="bg-white rounded-3xl shadow-2xl p-8 mb-10 border border-gray-100">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fa-solid fa-cog text-blue-600"></i>
            Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ
          </h2>
          <p class="text-gray-600 text-sm mt-1">ØªØ­Ø¯ÙŠØ¯ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø¨ÙŠØ¹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p>
        </div>
        <button id="saveProductSettings" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
          <i class="fa-solid fa-save"></i>
          Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© -->
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¬Ù†ÙŠÙ‡)</label>
          <input type="number" id="productCost" placeholder="200" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p class="text-xs text-gray-500">ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙˆØ§Ø­Ø¯</p>
        </div>

        <!-- Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ -->
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù†ÙŠÙ‡)</label>
          <input type="number" id="productPrice" placeholder="400" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p class="text-xs text-gray-500">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ø¹Ù…ÙŠÙ„</p>
        </div>

        <!-- ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† -->
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† (Ø¬Ù†ÙŠÙ‡)</label>
          <input type="number" id="shippingCost" placeholder="30" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p class="text-xs text-gray-500">Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†</p>
        </div>

        <!-- Ù…ØµØ§Ø±ÙŠÙ Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="space-y-2">
          <label class="block text-sm font-semibold text-gray-700">Ù…ØµØ§Ø±ÙŠÙ Ø¥Ø¶Ø§ÙÙŠØ© (%)</label>
          <input type="number" id="additionalCosts" placeholder="5" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
          <p class="text-xs text-gray-500">Ø¥Ø¹Ù„Ø§Ù†Ø§ØªØŒ Ø¹Ù…ÙˆÙ„Ø§ØªØŒ Ø¥Ù„Ø®</p>
        </div>
      </div>

      <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¨Ø­ -->
      <div class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-xl border border-green-200">
        <h3 class="font-semibold text-gray-800 mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¨Ø­ Ù„ÙƒÙ„ Ù…Ù†ØªØ¬:</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <span class="text-gray-600">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</span>
            <span id="previewSalePrice" class="font-bold text-green-600">400 Ø¬Ù†ÙŠÙ‡</span>
          </div>
          <div>
            <span class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©:</span>
            <span id="previewTotalCost" class="font-bold text-red-600">250 Ø¬Ù†ÙŠÙ‡</span>
          </div>
          <div>
            <span class="text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­:</span>
            <span id="previewNetProfit" class="font-bold text-blue-600">150 Ø¬Ù†ÙŠÙ‡</span>
          </div>
          <div>
            <span class="text-gray-600">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­:</span>
            <span id="previewProfitMargin" class="font-bold text-purple-600">37.5%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-10">

  <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  <div class="bg-white rounded-2xl p-6 shadow-md border-r-4 border-blue-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-500 text-xs font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        <p id="totalOrders" class="text-3xl font-bold text-gray-800 mb-1">0</p>
        <p class="text-gray-400 text-xs">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
      </div>
      <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center">
        <i class="fa-solid fa-shopping-cart text-blue-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… -->
  <div class="bg-white rounded-2xl p-6 shadow-md border-r-4 border-green-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-500 text-xs font-semibold mb-1">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>
        <p id="todayOrders" class="text-3xl font-bold text-gray-800 mb-1">0</p>
        <p class="text-gray-400 text-xs">Ø§Ù„ÙŠÙˆÙ…</p>
      </div>
      <div class="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center">
        <i class="fa-solid fa-calendar-day text-green-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
  <div class="bg-white rounded-2xl p-6 shadow-md border-r-4 border-orange-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-500 text-xs font-semibold mb-1">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</p>
        <p id="pendingOrders" class="text-3xl font-bold text-gray-800 mb-1">0</p>
        <p class="text-gray-400 text-xs">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
      </div>
      <div class="w-12 h-12 bg-orange-50 rounded-xl flex items-center justify-center">
        <i class="fa-solid fa-clock text-orange-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Ù…ÙƒØªÙ…Ù„Ø© -->
  <div class="bg-white rounded-2xl p-6 shadow-md border-r-4 border-purple-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-500 text-xs font-semibold mb-1">Ù…ÙƒØªÙ…Ù„Ø©</p>
        <p id="completedOrders" class="text-3xl font-bold text-gray-800">0</p>
      </div>
      <div class="w-12 h-12 bg-purple-50 rounded-xl flex items-center justify-center">
        <i class="fa-solid fa-check-circle text-purple-600 text-xl"></i>
      </div>
    </div>
  </div>

  <!-- Ø²ÙˆØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
  <div class="bg-white rounded-2xl p-6 shadow-md border-r-4 border-pink-500">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-500 text-xs font-semibold mb-1">Ø²ÙˆØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
        <p id="totalVisitors" class="text-3xl font-bold text-gray-800">0</p>
      </div>
      <div class="w-12 h-12 bg-pink-50 rounded-xl flex items-center justify-center">
        <i class="fa-solid fa-users text-pink-600 text-xl"></i>
      </div>
    </div>
  </div>

</div>


    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
<div class="bg-white rounded-3xl shadow-2xl p-8 mb-10 border border-gray-100">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
        <i class="fa-solid fa-chart-line text-green-600"></i>
        Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­
      </h2>
      <p class="text-gray-600 text-sm mt-1">ØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ù„Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p>
    </div>
    <button id="refreshFinancials" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
      <i class="fa-solid fa-refresh"></i>
      ØªØ­Ø¯ÙŠØ«
    </button>
  </div>

  <!-- ÙƒØ§Ø±Ø¯Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ -->
    <div class="bg-gradient-to-br from-green-500 via-green-600 to-green-700 text-white rounded-3xl p-6 shadow-2xl transform hover:scale-105 transition-all duration-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-green-100 text-xs font-semibold mb-1 uppercase tracking-wide">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ</p>
          <p id="dailyProfit" class="text-3xl font-bold mb-1">0 Ø¬Ù†ÙŠÙ‡</p>
          <p class="text-green-200 text-xs">Ø§Ù„ÙŠÙˆÙ…</p>
        </div>
        <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
          <i class="fa-solid fa-calendar-day text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ -->
    <div class="bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 text-white rounded-3xl p-6 shadow-2xl transform hover:scale-105 transition-all duration-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-blue-100 text-xs font-semibold mb-1 uppercase tracking-wide">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</p>
          <p id="monthlyProfit" class="text-3xl font-bold mb-1">0 Ø¬Ù†ÙŠÙ‡</p>
          <p class="text-blue-200 text-xs">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
        </div>
        <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
          <i class="fa-solid fa-calendar text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ -->
    <div class="bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white rounded-3xl p-6 shadow-2xl transform hover:scale-105 transition-all duration-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-purple-100 text-xs font-semibold mb-1 uppercase tracking-wide">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†ÙˆÙŠ</p>
          <p id="yearlyProfit" class="text-3xl font-bold mb-1">0 Ø¬Ù†ÙŠÙ‡</p>
          <p class="text-purple-200 text-xs">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…</p>
        </div>
        <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
          <i class="fa-solid fa-chart-bar text-xl"></i>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ -->
    <div class="bg-gradient-to-br from-yellow-500 via-yellow-600 to-yellow-700 text-white rounded-3xl p-6 shadow-2xl transform hover:scale-105 transition-all duration-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-yellow-100 text-xs font-semibold mb-1 uppercase tracking-wide">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p>
          <p id="totalProfit" class="text-3xl font-bold mb-1">0 Ø¬Ù†ÙŠÙ‡</p>
          <p class="text-yellow-200 text-xs">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</p>
        </div>
        <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center">
          <i class="fa-solid fa-coins text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- ØªÙØ§ØµÙŠÙ„ Ù…Ø§Ù„ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-2xl p-6 border border-gray-200">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-money-bill-wave text-green-600"></i>
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
      </h3>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„ÙŠÙˆÙ…:</span>
          <span id="dailySales" class="font-bold text-green-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø´Ù‡Ø±:</span>
          <span id="monthlySales" class="font-bold text-blue-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø³Ù†Ø©:</span>
          <span id="yearlySales" class="font-bold text-purple-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
      </div>
    </div>

    <!-- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ -->
    <div class="bg-gradient-to-r from-red-50 to-red-100 rounded-2xl p-6 border border-red-200">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-receipt text-red-600"></i>
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
      </h3>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„ÙŠÙˆÙ…:</span>
          <span id="dailyCosts" class="font-bold text-red-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø´Ù‡Ø±:</span>
          <span id="monthlyCosts" class="font-bold text-red-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø³Ù†Ø©:</span>
          <span id="yearlyCosts" class="font-bold text-red-600">0 Ø¬Ù†ÙŠÙ‡</span>
        </div>
      </div>
    </div>

    <!-- Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ -->
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl p-6 border border-blue-200">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i class="fa-solid fa-percentage text-blue-600"></i>
        Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­
      </h3>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„ÙŠÙˆÙ…:</span>
          <span id="dailyMargin" class="font-bold text-blue-600">0%</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø´Ù‡Ø±:</span>
          <span id="monthlyMargin" class="font-bold text-blue-600">0%</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">Ø§Ù„Ø³Ù†Ø©:</span>
          <span id="yearlyMargin" class="font-bold text-blue-600">0%</span>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª -->
    <div data-card="returns" class="bg-gradient-to-r from-red-500 to-red-600 text-white rounded-2xl p-6 shadow-lg transform hover:scale-105 transition-all duration-300">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-red-100 text-sm font-medium">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</p>
          <p id="totalReturns" class="text-3xl font-bold">0</p>
        </div>
        <div class="w-12 h-12 bg-red-400 rounded-xl flex items-center justify-center">
          <i class="fa-solid fa-undo text-xl"></i>
        </div>
      </div>
    </div>
  </div>
</div>


    <!-- Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div id="ordersSection">
      <!-- Controls -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fa-solid fa-list text-blue-600"></i>
            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </h2>
          <p class="text-gray-600 text-sm mt-1">Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª..." class="pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full sm:w-64">
            <i class="fa-solid fa-search absolute left-3 top-4 text-gray-400"></i>
          </div>

          <button id="refreshOrders" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2 shadow-lg">
            <i class="fa-solid fa-arrows-rotate"></i>
            ØªØ­Ø¯ÙŠØ«
          </button>

          <button id="exportData" class="border-2 border-green-200 hover:border-green-300 hover:bg-green-50 text-green-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
            <i class="fa-solid fa-file-excel"></i>
            ØªØµØ¯ÙŠØ± Excel
          </button>


        </div>
      </div>
    </div>

    <!-- Orders Table -->
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead>
            <tr class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 text-white">
              <th class="py-4 px-6 text-right font-semibold">
                <i class="fa-solid fa-user ml-2"></i>
                Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
              </th>
              <th class="py-4 px-6 text-right font-semibold">
                <i class="fa-solid fa-phone ml-2"></i>
                Ø§Ù„Ù‡Ø§ØªÙ
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-money-bill-1-wave"></i>
                Ø§Ù„Ø³Ø¹Ø±
              </th>
              <th class="py-4 px-6 text-right font-semibold">
                <i class="fa-solid fa-location-dot ml-2"></i>
                Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
              </th>
              <th class="py-4 px-6 text-right font-semibold">
                <i class="fa-solid fa-box ml-2"></i>
                Ø§Ù„Ù…Ù†ØªØ¬
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-hashtag ml-2"></i>
                Ø§Ù„ÙƒÙ…ÙŠØ©
              </th>
              
              
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-ticket ml-2"></i>
                Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-percent ml-2"></i>
                Ø§Ù„Ø®ØµÙ…
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-truck ml-2"></i>
                Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-calendar ml-2"></i>
                Ø§Ù„ØªØ§Ø±ÙŠØ®
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-phone-volume ml-2"></i>
                Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
              </th>
              <th class="py-4 px-6 text-center font-semibold">
                <i class="fa-solid fa-cog ml-2"></i>
                Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
              </th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr>
              <td colspan="9" class="py-8 text-center text-gray-500">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <div>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª -->
    <div id="returnsSection" class="hidden">
      <!-- Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… -->
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3">
            <i class="fa-solid fa-undo text-red-600"></i>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
          </h2>
          <div class="flex items-center gap-3">
            <button id="backToOrders" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
              <i class="fa-solid fa-arrow-left"></i>
              Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª
            </button>
            <button id="refreshReturns" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2">
              <i class="fa-solid fa-refresh"></i>
              ØªØ­Ø¯ÙŠØ«
            </button>
            <div class="relative">
              <input type="text" id="searchReturns" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500">
              <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª -->
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr class="bg-gradient-to-r from-red-800 to-red-900 text-white">
                <th class="py-5 px-6 text-right font-semibold">
                  <i class="fa-solid fa-user ml-2 text-red-300"></i>
                  Ø§Ù„Ø¹Ù…ÙŠÙ„
                </th>
                <th class="py-5 px-6 text-center font-semibold">
                  <i class="fa-solid fa-phone ml-2 text-green-300"></i>
                  Ø§Ù„Ù‡Ø§ØªÙ
                </th>
                <th class="py-5 px-6 text-right font-semibold">
                  <i class="fa-solid fa-box ml-2 text-blue-300"></i>
                  Ø§Ù„Ù…Ù†ØªØ¬
                </th>
                <th class="py-5 px-6 text-right font-semibold">
                  <i class="fa-solid fa-comment ml-2 text-yellow-300"></i>
                  Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
                </th>
                <th class="py-5 px-6 text-center font-semibold">
                  <i class="fa-solid fa-money-bill ml-2 text-purple-300"></i>
                  Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯
                </th>
                <th class="py-5 px-6 text-center font-semibold">
                  <i class="fa-solid fa-flag ml-2 text-orange-300"></i>
                  Ø§Ù„Ø­Ø§Ù„Ø©
                </th>
                <th class="py-5 px-6 text-center font-semibold">
                  <i class="fa-solid fa-calendar ml-2 text-indigo-300"></i>
                  Ø§Ù„ØªØ§Ø±ÙŠØ®
                </th>
                <th class="py-5 px-6 text-center font-semibold">
                  <i class="fa-solid fa-cog ml-2 text-gray-300"></i>
                  Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                </th>
              </tr>
            </thead>
            <tbody id="returnsTable">
              <tr>
                <td colspan="8" class="py-8 text-center text-gray-500">
                  <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                  <div>Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ -->
    <div id="returnDetailsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl p-6 max-w-2xl w-full shadow-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            <i class="fa-solid fa-undo text-red-600"></i>
            ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
          </h3>
          <button id="closeReturnDetails" class="text-gray-400 hover:text-gray-600 text-2xl">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <div id="returnDetailsContent" class="space-y-4">
          <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ -->
        </div>

        <div class="mt-6 pt-4 border-t border-gray-200">
          <div class="flex gap-3">
            <button id="updateReturnNotes" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
              <i class="fa-solid fa-save ml-1"></i>
              Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            </button>
            <button id="closeReturnDetailsBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">
              Ø¥ØºÙ„Ø§Ù‚
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot, where, Timestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeFqpa8MtVF5r3kKLfYZdM3EgPZCs3zeI",
    authDomain: "zamman-admin.firebaseapp.com",
    projectId: "zamman-admin",
    storageBucket: "zamman-admin.firebasestorage.app",
    messagingSenderId: "910842307850",
    appId: "1:910842307850:web:b7548b7a3323e1a19046f3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const authLoader = document.getElementById('authLoader');
  const mainContent = document.getElementById('mainContent');
  let hasPermissionIssues = false;
  let lastOrderTimestamp = null;
  let notificationPermission = false;

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  let productSettings = {
    cost: 200,           // Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©
    price: 400,          // Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹
    shippingCost: 30,    // ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†
    additionalCosts: 5   // Ù…ØµØ§Ø±ÙŠÙ Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
  };

  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  window.togglePermissionsHelp = function() {
    const help = document.getElementById('permissionsHelp');
    help.classList.toggle('hidden');
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  function showPermissionsAlert() {
    if (hasPermissionIssues) {
      document.getElementById('permissionsAlert').classList.remove('hidden');
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  function updateNotificationButton() {
    const btn = document.getElementById('notificationBtn');
    if (!btn) return;

    const icon = btn.querySelector('i');
    const text = btn.querySelector('span');

    if (Notification.permission === "granted") {
      icon.className = 'fa-solid fa-bell';
      btn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2';
      btn.title = 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©';
      if (text) text.textContent = 'Ù…ÙØ¹Ù„';
    } else {
      icon.className = 'fa-solid fa-bell-slash';
      btn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2';
      btn.title = 'Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª';
      if (text) text.textContent = 'Ù…Ø¹Ø·Ù„';
    }
  }

  // Ø¯Ø§Ù„Ø© Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  async function requestNotificationPermission() {
    if (!("Notification" in window)) {
      console.warn("Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨");
      updateNotificationButton();
      return false;
    }

    if (Notification.permission === "granted") {
      console.log("âœ… Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙÙ…Ù†ÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„");
      notificationPermission = true;
      updateNotificationButton();
      return true;
    }

    if (Notification.permission === "denied") {
      console.warn("âŒ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø±ÙÙˆØ¶");
      updateNotificationButton();
      showNotificationPermissionDialog();
      return false;
    }

    // Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø°Ù†
    try {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        console.log("âœ… ØªÙ… Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
        notificationPermission = true;
        updateNotificationButton();

        // Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ
        showWelcomeNotification();
        return true;
      } else {
        console.warn("âŒ ØªÙ… Ø±ÙØ¶ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");
        updateNotificationButton();
        showNotificationPermissionDialog();
        return false;
      }
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:", error);
      updateNotificationButton();
      return false;
    }
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ÙŠ
  function showWelcomeNotification() {
    new Notification("AQRAB Admin", {
      body: "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.",
      icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âŒš</text></svg>",
      badge: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ””</text></svg>",
      tag: "welcome",
      requireInteraction: false,
      silent: false
    });
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø­ÙˆØ§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  function showNotificationPermissionDialog() {
    const dialog = document.createElement('div');
    dialog.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
    dialog.innerHTML = `
      <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">ğŸ””</div>
          <h3 class="text-xl font-bold text-gray-900 mb-2">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
          <p class="text-gray-600 text-sm">Ù„ØªÙ„Ù‚ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <h4 class="font-semibold text-blue-900 mb-2">ÙƒÙŠÙÙŠØ© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</h4>
          <ol class="text-sm text-blue-800 space-y-1">
            <li>1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚ÙÙ„ ğŸ”’ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</li>
            <li>2. Ø§Ø®ØªØ± "Ø§Ù„Ø³Ù…Ø§Ø­" Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>
            <li>3. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</li>
          </ol>
        </div>

        <div class="flex gap-3">
          <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-lg font-medium transition">
            ØªØ®Ø·ÙŠ
          </button>
          <button onclick="window.location.reload()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition">
            Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
          </button>
        </div>
      </div>
    `;

    document.body.appendChild(dialog);
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·)
  function createOrderNotification(order, orderId) {
    console.log("ğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ø±Ø¯:", order.name);

    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    playNotificationSound();

    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­
    showBrowserNotification(order, orderId);
  }

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
  window.viewOrderDetails = function(orderId) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØªÙ…ÙŠÙŠØ²Ù‡
    const rows = document.querySelectorAll('#ordersTable tr');
    rows.forEach(row => {
      const orderIdCell = row.querySelector('td:first-child');
      if (orderIdCell && orderIdCell.textContent.includes(orderId.substring(0, 8).toUpperCase())) {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        row.style.backgroundColor = '#fef3c7';
        setTimeout(() => {
          row.style.backgroundColor = '';
        }, 3000);
      }
    });
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ (Ù…Ø­Ø³Ù‘Ù†Ø© ÙˆÙ…ÙØµÙ„Ø©)
  function showBrowserNotification(order, orderId) {
    if (!notificationPermission || Notification.permission !== "granted") {
      console.log("ğŸ“µ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…ÙØ¹Ù„Ø© - ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù…Ù† Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª");

      // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
      console.log(`%cğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${order.name}`, 'background: #4ade80; color: white; padding: 8px; border-radius: 4px; font-weight: bold;');
      console.log(`ğŸ“± ${order.phone} | ğŸ’° ${order.totalWithShipping || order.price || '400'} Ø¬Ù†ÙŠÙ‡`);
      return;
    }

    try {
      // ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¹ Ø§Ù„Ø´Ø­Ù†
      const title = `ğŸ›’ AQRAB - Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${order.name}`;
      const basePrice = order.totalBeforeDiscount || order.price || '400';
      const shippingCost = order.shippingCost || productSettings.shippingCost;
      const totalWithShipping = order.totalWithShipping || (parseFloat(basePrice) + parseFloat(shippingCost));
      const discountText = order.discountApplied > 0 ? `\nğŸŸï¸ Ø®ØµÙ…: ${order.discountApplied} Ø¬Ù†ÙŠÙ‡` : '';
      const couponText = order.couponCode ? `\nğŸ« ÙƒÙˆØ¨ÙˆÙ†: ${order.couponCode}` : '';

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
      const now = new Date();
      const timeString = now.toLocaleTimeString('ar-EG', {
        hour: '2-digit',
        minute: '2-digit'
      });

      const body = `â° ${timeString}
ğŸ“± ${order.phone}
ğŸ“¦ ${order.product || 'Ø³Ø§Ø¹Ø© ÙƒØ±Ø¨ÙˆÙ† Ø£Ø³ÙˆØ¯'}
ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©: ${order.quantity || 1}
ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${totalWithShipping} Ø¬Ù†ÙŠÙ‡${discountText}${couponText}
ğŸ“ ${order.address.length > 60 ? order.address.substring(0, 60) + '...' : order.address}

ğŸ‘† Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…`;

      const notification = new Notification(title, {
        body: body,
        icon: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234ade80' stroke='%23ffffff' stroke-width='3'/><text x='50' y='65' font-size='45' text-anchor='middle' fill='white'>âŒš</text></svg>",
        badge: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23ef4444'/><text x='50' y='65' font-size='35' text-anchor='middle' fill='white'>ğŸ›’</text></svg>",
        tag: `aqrab-order-${orderId}`,
        requireInteraction: true,
        silent: false,
        timestamp: Date.now(),
        data: {
          orderId: orderId,
          orderData: order,
          url: window.location.href,
          timestamp: now.toISOString()
        }
      });

      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      notification.onclick = function(event) {
        event.preventDefault();
        console.log("ğŸ‘† ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨:", orderId);

        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø£Ùˆ ÙØªØ­Ù‡Ø§
        if (window.focus) {
          window.focus();
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø®ÙÙŠØ©ØŒ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
        if (document.hidden || document.visibilityState === 'hidden') {
          const newWindow = window.open(window.location.href, '_blank');
          if (newWindow) {
            newWindow.focus();
          }
        }

        // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
        setTimeout(() => {
          viewOrderDetails(orderId);
        }, 800);

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        notification.close();
      };

      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      notification.onshow = function() {
        console.log("âœ… ØªÙ… Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„Ø·Ù„Ø¨:", order.name);
      };

      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      notification.onclose = function() {
        console.log("ğŸ”• ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­");
      };

      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      notification.onerror = function(error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­:", error);
      };

      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© (ÙˆÙ‚Øª Ø£Ø·ÙˆÙ„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©)
      setTimeout(() => {
        if (notification) {
          notification.close();
        }
      }, 30000);

      console.log("ğŸ”” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…ÙØµÙ„ Ù„Ù„Ø·Ù„Ø¨:", order.name);

    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­:", error);

      // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
      console.log(`%cğŸ”” Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ (Ø§Ø­ØªÙŠØ§Ø·ÙŠ): ${order.name}`, 'background: #ef4444; color: white; padding: 8px; border-radius: 4px; font-weight: bold;');
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
  function playNotificationSound() {
    try {
      // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    } catch (error) {
      console.warn("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error);
    }
  }

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ

  // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  function loadProductSettings() {
    const saved = localStorage.getItem('productSettings');
    if (saved) {
      productSettings = JSON.parse(saved);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('productCost').value = productSettings.cost;
    document.getElementById('productPrice').value = productSettings.price;
    document.getElementById('shippingCost').value = productSettings.shippingCost;
    document.getElementById('additionalCosts').value = productSettings.additionalCosts;

    updateProfitPreview();
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  function validateProductSettings() {
    const cost = parseFloat(document.getElementById('productCost').value);
    const price = parseFloat(document.getElementById('productPrice').value);
    const shipping = parseFloat(document.getElementById('shippingCost').value);
    const additional = parseFloat(document.getElementById('additionalCosts').value);

    const errors = [];

    if (isNaN(cost) || cost < 0) {
      errors.push("Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨");
    }

    if (isNaN(price) || price <= 0) {
      errors.push("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨");
    }

    if (isNaN(shipping) || shipping < 0) {
      errors.push("ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù… Ù…ÙˆØ¬Ø¨ Ø£Ùˆ ØµÙØ±");
    }

    if (isNaN(additional) || additional < 0 || additional > 100) {
      errors.push("Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† 0 Ùˆ 100");
    }

    if (price <= cost) {
      errors.push("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©");
    }

    return errors;
  }

  // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ù…Ø­Ø³Ù‘Ù†Ø©)
  function saveProductSettings() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const errors = validateProductSettings();

    if (errors.length > 0) {
      showNotification("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:\n" + errors.join("\n"), "error");
      return;
    }

    productSettings = {
      cost: parseFloat(document.getElementById('productCost').value),
      price: parseFloat(document.getElementById('productPrice').value),
      shippingCost: parseFloat(document.getElementById('shippingCost').value),
      additionalCosts: parseFloat(document.getElementById('additionalCosts').value)
    };

    localStorage.setItem('productSettings', JSON.stringify(productSettings));
    updateProfitPreview();

    showNotification("ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­", "success");

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
    calculateFinancialStats();

    console.log("ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬:", productSettings);
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¨Ø­ (Ù…Ø­Ø³Ù‘Ù†Ø©)
  function updateProfitPreview() {
    const cost = parseFloat(document.getElementById('productCost').value) || productSettings.cost;
    const price = parseFloat(document.getElementById('productPrice').value) || productSettings.price;
    const shipping = parseFloat(document.getElementById('shippingCost').value) || productSettings.shippingCost;
    const additional = parseFloat(document.getElementById('additionalCosts').value) || productSettings.additionalCosts;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠÙ…
    if (cost < 0 || price < 0 || shipping < 0 || additional < 0) {
      document.getElementById('previewSalePrice').textContent = 'Ù‚ÙŠÙ… ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
      return;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    const additionalCostAmount = (price * additional) / 100;
    const totalCost = cost + shipping + additionalCostAmount;
    const netProfit = price - totalCost;
    const profitMargin = price > 0 ? ((netProfit / price) * 100) : 0;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø£ÙØ¶Ù„
    document.getElementById('previewSalePrice').textContent = `${price.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
    document.getElementById('previewTotalCost').textContent = `${totalCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;

    // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø±Ø¨Ø­ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø©
    const profitElement = document.getElementById('previewNetProfit');
    const marginElement = document.getElementById('previewProfitMargin');

    profitElement.textContent = `${netProfit.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
    marginElement.textContent = `${profitMargin.toFixed(1)}%`;

    // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ø±Ø¨Ø­ÙŠØ©
    if (netProfit > 0) {
      profitElement.className = 'font-bold text-green-600';
      marginElement.className = 'font-bold text-green-600';
    } else if (netProfit === 0) {
      profitElement.className = 'font-bold text-yellow-600';
      marginElement.className = 'font-bold text-yellow-600';
    } else {
      profitElement.className = 'font-bold text-red-600';
      marginElement.className = 'font-bold text-red-600';
    }
  }

  // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ù„Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ (Ù…Ø­Ø³Ù‘Ù†Ø© Ù…Ø¹ Ø§Ù„Ø´Ø­Ù†)
  function calculateOrderProfit(order) {
    const quantity = parseInt(order.quantity) || 1;

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø·Ù„Ø¨
    let basePrice = productSettings.price; // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨
    if (order.totalWithShipping) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¨Ù„Øº Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø´Ø­Ù†ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
      basePrice = parseFloat(order.totalWithShipping);
    } else if (order.totalBeforeDiscount) {
      // Ø§Ù„Ø³Ø¹Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ… + ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†
      basePrice = parseFloat(order.totalBeforeDiscount) + (parseFloat(order.shippingCost) || productSettings.shippingCost);
    } else if (order.price) {
      // Ø§Ù„Ø³Ø¹Ø± + ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†
      basePrice = parseFloat(order.price) + (parseFloat(order.shippingCost) || productSettings.shippingCost);
    } else {
      // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ + ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù†
      basePrice = productSettings.price + productSettings.shippingCost;
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø·Ø¨Ù‚
    const discount = parseFloat(order.discountApplied) || parseFloat(order.discount) || 0;

    // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (ÙŠØ´Ù…Ù„ Ø§Ù„Ø´Ø­Ù†)
    const finalPrice = Math.max(0, basePrice - discount);

    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    const productCost = productSettings.cost * quantity; // ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    const shippingCostUsed = parseFloat(order.shippingCost) || productSettings.shippingCost; // ØªÙƒÙ„ÙØ© Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙØ¹Ù„ÙŠØ©
    const additionalCostAmount = ((finalPrice - shippingCostUsed) * productSettings.additionalCosts) / 100; // Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø´Ø­Ù†)

    const totalCost = productCost + shippingCostUsed + additionalCostAmount;
    const totalRevenue = finalPrice;
    const profit = totalRevenue - totalCost;

    // Ø­Ø³Ø§Ø¨ Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­
    const margin = totalRevenue > 0 ? ((profit / totalRevenue) * 100) : 0;

    return {
      revenue: totalRevenue,
      cost: totalCost,
      profit: profit,
      margin: margin,
      quantity: quantity,
      basePrice: basePrice,
      finalPrice: finalPrice,
      discount: discount,
      productCost: productCost,
      shippingCost: shippingCostUsed,
      additionalCost: additionalCostAmount
    };
  }

  // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù…Ø­Ø³Ù‘Ù†Ø©)
  async function calculateFinancialStats() {
    try {
      console.log("ğŸ’° Ø¨Ø¯Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©...");

      const querySnapshot = await getDocs(collection(db, "orders"));

      if (querySnapshot.empty) {
        console.log("ğŸ“Š Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª");
        updateFinancialUI(
          { revenue: 0, cost: 0, profit: 0, orders: 0 },
          { revenue: 0, cost: 0, profit: 0, orders: 0 },
          { revenue: 0, cost: 0, profit: 0, orders: 0 },
          { revenue: 0, cost: 0, profit: 0, orders: 0 }
        );
        return;
      }

      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const thisYear = new Date(now.getFullYear(), 0, 1);

      let dailyStats = { revenue: 0, cost: 0, profit: 0, orders: 0 };
      let monthlyStats = { revenue: 0, cost: 0, profit: 0, orders: 0 };
      let yearlyStats = { revenue: 0, cost: 0, profit: 0, orders: 0 };
      let totalStats = { revenue: 0, cost: 0, profit: 0, orders: 0 };

      let processedOrders = 0;
      let skippedOrders = 0;

      querySnapshot.forEach((doc) => {
        const order = doc.data();

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­
        if (!order.date) {
          skippedOrders++;
          console.warn("âš ï¸ Ø·Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®:", doc.id);
          return;
        }

        const orderDate = new Date(order.date);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (isNaN(orderDate.getTime())) {
          skippedOrders++;
          console.warn("âš ï¸ Ø·Ù„Ø¨ Ø¨ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­:", doc.id, order.date);
          return;
        }

        const orderProfit = calculateOrderProfit(order);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
        if (isNaN(orderProfit.revenue) || isNaN(orderProfit.cost) || isNaN(orderProfit.profit)) {
          skippedOrders++;
          console.warn("âš ï¸ Ø·Ù„Ø¨ Ø¨Ø­Ø³Ø§Ø¨Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©:", doc.id);
          return;
        }

        processedOrders++;

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        totalStats.revenue += orderProfit.revenue;
        totalStats.cost += orderProfit.cost;
        totalStats.profit += orderProfit.profit;
        totalStats.orders += 1;

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (orderDate >= thisYear) {
          yearlyStats.revenue += orderProfit.revenue;
          yearlyStats.cost += orderProfit.cost;
          yearlyStats.profit += orderProfit.profit;
          yearlyStats.orders += 1;
        }

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (orderDate >= thisMonth) {
          monthlyStats.revenue += orderProfit.revenue;
          monthlyStats.cost += orderProfit.cost;
          monthlyStats.profit += orderProfit.profit;
          monthlyStats.orders += 1;
        }

        // Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (orderDate >= today) {
          dailyStats.revenue += orderProfit.revenue;
          dailyStats.cost += orderProfit.cost;
          dailyStats.profit += orderProfit.profit;
          dailyStats.orders += 1;
        }
      });

      // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      updateFinancialUI(dailyStats, monthlyStats, yearlyStats, totalStats);

      console.log(`âœ… ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­:`);
      console.log(`ğŸ“Š ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${processedOrders} Ø·Ù„Ø¨ØŒ ØªÙ… ØªØ®Ø·ÙŠ ${skippedOrders} Ø·Ù„Ø¨`);

    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:", error);
      showNotification("Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©", "error");
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù…Ø­Ø³Ù‘Ù†Ø©)
  function updateFinancialUI(daily, monthly, yearly, total) {
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
    function formatCurrency(amount) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount) + ' Ø¬Ù†ÙŠÙ‡';
    }

    function formatPercentage(percentage) {
      return percentage.toFixed(1) + '%';
    }

    // Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ø³Ù‘Ù†
    document.getElementById('dailyProfit').textContent = formatCurrency(daily.profit);
    document.getElementById('monthlyProfit').textContent = formatCurrency(monthly.profit);
    document.getElementById('yearlyProfit').textContent = formatCurrency(yearly.profit);
    document.getElementById('totalProfit').textContent = formatCurrency(total.profit);

    // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    document.getElementById('dailySales').textContent = formatCurrency(daily.revenue);
    document.getElementById('monthlySales').textContent = formatCurrency(monthly.revenue);
    document.getElementById('yearlySales').textContent = formatCurrency(yearly.revenue);

    // Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    document.getElementById('dailyCosts').textContent = formatCurrency(daily.cost);
    document.getElementById('monthlyCosts').textContent = formatCurrency(monthly.cost);
    document.getElementById('yearlyCosts').textContent = formatCurrency(yearly.cost);

    // Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­
    const dailyMargin = daily.revenue > 0 ? ((daily.profit / daily.revenue) * 100) : 0;
    const monthlyMargin = monthly.revenue > 0 ? ((monthly.profit / monthly.revenue) * 100) : 0;
    const yearlyMargin = yearly.revenue > 0 ? ((yearly.profit / yearly.revenue) * 100) : 0;

    document.getElementById('dailyMargin').textContent = formatPercentage(dailyMargin);
    document.getElementById('monthlyMargin').textContent = formatPercentage(monthlyMargin);
    document.getElementById('yearlyMargin').textContent = formatPercentage(yearlyMargin);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    console.log("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:");
    console.log(`ğŸ“… Ø§Ù„ÙŠÙˆÙ…: ${daily.orders} Ø·Ù„Ø¨ØŒ Ø±Ø¨Ø­ ${daily.profit.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
    console.log(`ğŸ“… Ø§Ù„Ø´Ù‡Ø±: ${monthly.orders} Ø·Ù„Ø¨ØŒ Ø±Ø¨Ø­ ${monthly.profit.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
    console.log(`ğŸ“… Ø§Ù„Ø³Ù†Ø©: ${yearly.orders} Ø·Ù„Ø¨ØŒ Ø±Ø¨Ø­ ${yearly.profit.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
    console.log(`ğŸ“… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.orders} Ø·Ù„Ø¨ØŒ Ø±Ø¨Ø­ ${total.profit.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
  }

  // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  async function initializeCollections() {
    try {
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© visitors Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      const visitorsRef = collection(db, "visitors");
      const visitorsSnapshot = await getDocs(visitorsRef);

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© returns Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      const returnsRef = collection(db, "returns");
      const returnsSnapshot = await getDocs(returnsRef);

      console.log("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    } catch (error) {
      console.warn("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©:", error.message);
    }
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, (user) => {
    setTimeout(async () => {
      if (!user) {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.location.href = "login.html";
      } else {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        authLoader.classList.add('fade-out');
        setTimeout(async () => {
          authLoader.classList.add('hidden');
          mainContent.classList.add('show');

          // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
          await initializeCollections();

          // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
          await requestNotificationPermission();

          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
          loadProductSettings();

          // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          startOrdersListener();
        }, 500);
      }
    }, 1000); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ¯Ø± Ù„Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
  });

  // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
      signOut(auth).then(() => {
        localStorage.removeItem('rememberAdmin');
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:", error);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
        window.location.href = "login.html";
      });
    }
  });

  // Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  function startOrdersListener() {
    try {
      console.log("ğŸ”” Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...");

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
      const ordersQuery = query(
        collection(db, "orders"),
        orderBy("date", "desc")
      );

      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ
      const unsubscribe = onSnapshot(ordersQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") {
            const order = change.doc.data();
            const orderId = change.doc.id;
            const orderTimestamp = new Date(order.date).getTime();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆÙ„ÙŠØ³ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
            if (lastOrderTimestamp === null) {
              // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ - Ø­ÙØ¸ Ø¢Ø®Ø± Ø·Ù„Ø¨ ÙÙ‚Ø·
              lastOrderTimestamp = orderTimestamp;
              console.log("ğŸ“Š ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª");
            } else if (orderTimestamp > lastOrderTimestamp) {
              // Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!
              console.log("ğŸ†• Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø§ÙƒØªØ´Ø§ÙÙ‡:", order.name);
              createOrderNotification(order, orderId);
              lastOrderTimestamp = orderTimestamp;

              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              setTimeout(() => {
                loadOrders();
              }, 1000);
            }
          }
        });
      }, (error) => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", error);

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
        setTimeout(() => {
          console.log("ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª...");
          startOrdersListener();
        }, 5000);
      });

      // Ø­ÙØ¸ Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      window.unsubscribeOrders = unsubscribe;

    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª:", error);
    }
  }

  // ØªØ±Ø¬Ù…Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  const statusTranslations = {
    'pending': 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
    'shipped': 'ØªÙ… Ø§Ù„Ø´Ø­Ù†',
    'on_the_way': 'ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚',
    'delivered': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
    'received': 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'
  };

  const statusColors = {
    'pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
    'shipped': 'bg-blue-100 text-blue-800 border-blue-200',
    'on_the_way': 'bg-purple-100 text-purple-800 border-purple-200',
    'delivered': 'bg-green-100 text-green-800 border-green-200',
    'received': 'bg-gray-100 text-gray-800 border-gray-200'
  };

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  async function updateOrderStatus(orderId, newStatus) {
    try {
      await updateDoc(doc(db, "orders", orderId), {
        status: newStatus
      });
      showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success");
      loadOrders(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", error);
      showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
    }
  }

  async function loadOrders() {
    const tbody = document.getElementById("ordersTable");
    const totalOrdersEl = document.getElementById("totalOrders");
    const todayOrdersEl = document.getElementById("todayOrders");

    tbody.innerHTML = `
      <tr>
        <td colspan="11" class="py-8 text-center text-gray-500">
          <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
          <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </td>
      </tr>
    `;

    try {
      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ ÙƒØ§Ù† Ù†ØµÙŠØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹
      let querySnapshot;
      try {
        const ordersQuery = query(collection(db, "orders"), orderBy("date", "desc"));
        querySnapshot = await getDocs(ordersQuery);
      } catch (error) {
        console.warn("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®ØŒ Ø³ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨:", error);
        querySnapshot = await getDocs(collection(db, "orders"));
      }

      if (querySnapshot.empty) {
        tbody.innerHTML = `
          <tr>
            <td colspan="11" class="py-12 text-center text-gray-500">
              <i class="fa-solid fa-inbox text-4xl mb-4 text-gray-300"></i>
              <div class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
              <div class="text-sm">Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‡Ù†Ø§</div>
            </td>
          </tr>
        `;
        totalOrdersEl.textContent = "0";
        todayOrdersEl.textContent = "0";
        return;
      }

      tbody.innerHTML = "";
      let todayCount = 0;
      const today = new Date().toDateString();

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ÙŠØ¯ÙˆÙŠ
      const ordersArray = [];
      querySnapshot.forEach(docSnap => {
        ordersArray.push({
          id: docSnap.id,
          data: docSnap.data()
        });
      });

      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      ordersArray.sort((a, b) => {
        const dateA = new Date(a.data.date);
        const dateB = new Date(b.data.date);
        return dateB - dateA; // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      });

      ordersArray.forEach(orderDoc => {
        const docSnap = { id: orderDoc.id, data: () => orderDoc.data };
        const order = orderDoc.data;
        const orderDate = new Date(order.date);
        const formattedDate = orderDate.toLocaleDateString('ar-EG', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        if (orderDate.toDateString() === today) {
          todayCount++;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„ØµÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„
        const isContacted = order.contacted === true;
        const rowClass = isContacted
          ? "border-b border-black/5 hover:bg-green-50 transition-colors bg-green-50/50"
          : "border-b border-black/5 hover:bg-gray-50 transition-colors";

        tbody.innerHTML += `
          <tr class="${rowClass}" data-order-id="${docSnap.id}">
            <td class="py-4 px-6 text-right">
              <div class="font-medium">${order.name || "-"}</div>
            </td>
            <td class="py-4 px-6 text-right">
              <a href="tel:${order.phone}" class="text-black hover:text-gray-600 flex items-center gap-2">
                <i class="fa-solid fa-phone text-sm"></i>
                ${order.phone || "-"}
              </a>
            </td>
            <td class="py-4 px-6 text-right">
              <div class="font-medium">${order.price || order.totalBeforeDiscount || "400"} Ø¬Ù†ÙŠÙ‡</div>
              ${order.discountApplied > 0 ? `<div class="text-xs text-green-600">Ø®ØµÙ…: -${order.discountApplied} Ø¬Ù†ÙŠÙ‡</div>` : ''}
            </td>
            <td class="py-4 px-6 text-right">
              <div class="max-w-xs truncate" title="${order.address || "-"}">
                ${order.address || "-"}
              </div>
            </td>
            
            <td class="py-4 px-6 text-right">
              <div class="font-medium">${order.product || "-"}</div>
            </td>
            
            <td class="py-4 px-6 text-center">
              <span class="bg-black/5 px-2 py-1 rounded-lg font-medium">
                ${order.quantity || "-"}
              </span>
            </td>
            
            <td class="py-4 px-6 text-center">
              ${order.couponCode ?
                `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-lg text-xs font-medium">
                  <i class="fa-solid fa-ticket ml-1"></i>
                  ${order.couponCode}
                </span>` :
                `<span class="text-gray-400 text-sm">-</span>`
              }
            </td>
            <td class="py-4 px-6 text-center">
              ${order.discountApplied > 0 ?
                `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-lg text-xs font-medium">
                  <i class="fa-solid fa-minus ml-1"></i>
                  ${order.discountApplied} Ø¬Ù†ÙŠÙ‡
                </span>` :
                `<span class="text-gray-400 text-sm">-</span>`
              }
            </td>
            
            <td class="py-4 px-6 text-center">
              <div class="relative">
                <select class="status-dropdown bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 ${statusColors[order.status || 'pending']}" data-order-id="${docSnap.id}" data-current-status="${order.status || 'pending'}">
                  <option value="pending" ${(order.status || 'pending') === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø´Ø­Ù†</option>
                  <option value="on_the_way" ${order.status === 'on_the_way' ? 'selected' : ''}>ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</option>
                  <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
                  <option value="received" ${order.status === 'received' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
                </select>
              </div>
            </td>
            <td class="py-4 px-6 text-center text-sm text-gray-600">
              ${formattedDate}
            </td>
            <td class="py-4 px-6 text-center">
              <button class="contact-btn px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1 mx-auto ${isContacted
                ? 'bg-green-100 text-green-800 border border-green-300'
                : 'bg-blue-600 hover:bg-blue-700 text-white'}"
                data-order-id="${docSnap.id}"
                data-contacted="${isContacted}">
                <i class="fa-solid ${isContacted ? 'fa-check-circle' : 'fa-phone'}"></i>
                ${isContacted ? 'ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„' : 'ØªÙˆØ§ØµÙ„'}
              </button>
            </td>
            <td class="py-4 px-6 text-center">
              <div class="flex items-center justify-center gap-2">
                <button class="bg-black hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1 whatsapp-btn" data-phone="${order.phone}" data-name="${order.name}">
                  <i class="fa-brands fa-whatsapp"></i>
                  ÙˆØ§ØªØ³Ø§Ø¨
                </button>
                <button class="border border-red-500 hover:bg-red-500 hover:text-white text-red-500 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1 delete-btn" data-id="${docSnap.id}">
                  <i class="fa-solid fa-trash"></i>
                  Ø­Ø°Ù
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      // Update stats
      totalOrdersEl.textContent = ordersArray.length;
      todayOrdersEl.textContent = todayCount;

      // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
            try {
              btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
              btn.disabled = true;

              await deleteDoc(doc(db, "orders", btn.getAttribute("data-id")));

              // Show success message
              showNotification("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", "success");
              loadOrders(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
            } catch (error) {
              console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
              showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù", "error");
              btn.innerHTML = '<i class="fa-solid fa-trash"></i> Ø­Ø°Ù';
              btn.disabled = false;
            }
          }
        });
      });

      // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
      document.querySelectorAll(".whatsapp-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const phone = btn.getAttribute("data-phone");
          const name = btn.getAttribute("data-name");
          const message = encodeURIComponent(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}ØŒ Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ ÙÙŠ 3qrab. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù„ØªØ£ÙƒÙŠØ¯ ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ.`);
          const whatsappUrl = `https://wa.me/${phone.replace('+', '')}?text=${message}`;
          window.open(whatsappUrl, '_blank');
        });
      });

      // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„
      document.querySelectorAll(".contact-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const orderId = btn.getAttribute("data-order-id");
          const isCurrentlyContacted = btn.getAttribute("data-contacted") === "true";
          const newContactedStatus = !isCurrentlyContacted;

          try {
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
            btn.disabled = true;

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await updateDoc(doc(db, "orders", orderId), {
              contacted: newContactedStatus,
              contactedAt: newContactedStatus ? new Date().toISOString() : null
            });
const row = btn.closest('tr');
if (newContactedStatus) {
  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø±
  btn.className =
    'contact-btn px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1 mx-auto bg-green-100 text-green-800 border border-green-300';
  btn.innerHTML = '<i class="fa-solid fa-check-circle"></i> ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„';

  // Ø¬Ø¹Ù„ Ø§Ù„ØµÙ Ø£Ø®Ø¶Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§
  row.className =
    'border-b border-black/5 bg-green-100'; 
} else {
  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø²Ø±
  btn.className =
    'contact-btn px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-1 mx-auto bg-blue-600 hover:bg-blue-700 text-white';
  btn.innerHTML = '<i class="fa-solid fa-phone"></i> ØªÙˆØ§ØµÙ„';

  // Ø§Ù„ØµÙ ÙŠØ±Ø¬Ø¹ Ø¹Ø§Ø¯ÙŠ
  row.className =
    'border-b border-black/5 hover:bg-gray-50 transition-colors';
}

btn.setAttribute("data-contacted", newContactedStatus.toString());
btn.disabled = false;

            showNotification(newContactedStatus ? "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„", "success");
          } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„:", error);
            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„", "error");
            btn.disabled = false;
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ
            btn.innerHTML = isCurrentlyContacted
              ? '<i class="fa-solid fa-check-circle"></i> ØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„'
              : '<i class="fa-solid fa-phone"></i> ØªÙˆØ§ØµÙ„';
          }
        });
      });

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
      document.querySelectorAll(".status-dropdown").forEach(dropdown => {
        dropdown.addEventListener("change", async (e) => {
          const orderId = e.target.getAttribute("data-order-id");
          const newStatus = e.target.value;
          const currentStatus = e.target.getAttribute("data-current-status");

          if (newStatus !== currentStatus) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙˆØ±Ø§Ù‹
            e.target.className = `status-dropdown bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 ${statusColors[newStatus]}`;

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            await updateOrderStatus(orderId, newStatus);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            e.target.setAttribute("data-current-status", newStatus);
          }
        });
      });

    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);

      if (error.code === 'permission-denied') {
        // Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="py-12 text-center">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 max-w-md mx-auto">
                <i class="fa-solid fa-lock text-yellow-600 text-3xl mb-3"></i>
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
                <p class="text-yellow-700 text-sm mb-4">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firebase.</p>
                <div class="bg-yellow-100 border border-yellow-300 rounded p-3 text-xs text-yellow-800">
                  <strong>Ù„Ù„Ù…Ø·ÙˆØ±:</strong> ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firestore ÙÙŠ Firebase Console
                </div>
              </div>
            </td>
          </tr>
        `;
      } else {
        // Ø®Ø·Ø£ Ø¢Ø®Ø±
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="py-12 text-center text-red-500">
              <i class="fa-solid fa-exclamation-triangle text-4xl mb-4"></i>
              <div class="text-lg font-medium">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>
              <div class="text-sm">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>
            </td>
          </tr>
        `;
      }
    }
  }

  // Notification function
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;

    if (type === 'success') {
      notification.className += ' bg-green-100 border border-green-200 text-green-800';
      notification.innerHTML = `<i class="fa-solid fa-check-circle ml-2"></i>${message}`;
    } else if (type === 'error') {
      notification.className += ' bg-red-100 border border-red-200 text-red-800';
      notification.innerHTML = `<i class="fa-solid fa-exclamation-circle ml-2"></i>${message}`;
    } else {
      notification.className += ' bg-blue-100 border border-blue-200 text-blue-800';
      notification.innerHTML = `<i class="fa-solid fa-info-circle ml-2"></i>${message}`;
    }

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);

    // Animate out and remove
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // Export data function with Excel format and financial calculations
  window.exportData = async function() {
    try {
      const querySnapshot = await getDocs(collection(db, "orders"));
      if (querySnapshot.empty) {
        showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±", "error");
        return;
      }

      // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      const orders = [];
      let totalRevenue = 0;
      let totalOrders = 0;
      let totalQuantity = 0;
      let totalDiscounts = 0;
      let statusCounts = { pending: 0, confirmed: 0, shipped: 0, delivered: 0, cancelled: 0 };

      querySnapshot.forEach(docSnap => {
        const order = docSnap.data();
        orders.push(order);

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        totalOrders++;
        totalQuantity += parseInt(order.quantity) || 0;
        totalRevenue += parseFloat(order.price) || 0;
        totalDiscounts += parseFloat(order.discountApplied) || 0;

        const status = order.status || 'pending';
        if (statusCounts.hasOwnProperty(status)) {
          statusCounts[status]++;
        }
      });

      // Ø¥Ù†Ø´Ø§Ø¡ Workbook Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SheetJS
      const wb = XLSX.utils.book_new();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ worksheet
      const wsData = [];

     
      // Ø±Ø£Ø³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      wsData.push(['ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª']);
      wsData.push([
        'Ù…',
        'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„',
        'Ø§Ù„Ù‡Ø§ØªÙ',
        'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
        'Ø§Ù„Ù…Ù†ØªØ¬',
        'Ø§Ù„ÙƒÙ…ÙŠØ©',
        'Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©',
        'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…',
        'Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…',
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ',
        'ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',
        'Ø§Ù„Ø­Ø§Ù„Ø©',
        'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª'
      ]);

      // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      orders.forEach((order, index) => {
        const orderDate = order.date ? new Date(order.date) : new Date();
        const formattedDateTime = orderDate.toLocaleDateString('ar-EG', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        const unitPrice = parseFloat(order.unitPrice || 400);
        const quantity = parseInt(order.quantity || 1);
        const totalBeforeDiscount = parseFloat(order.totalBeforeDiscount || (unitPrice * quantity));
        const discountAmount = parseFloat(order.discountApplied || 0);
        const finalPrice = parseFloat(order.price || (totalBeforeDiscount - discountAmount));

        wsData.push([
          index + 1,
          order.name || '',
          order.phone || '',
          order.address || '',
          order.product || 'Ø³Ø§Ø¹Ø© ÙƒØ±Ø¨ÙˆÙ† Ø£Ø³ÙˆØ¯ â€” Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©',
          quantity,
          unitPrice,
          totalBeforeDiscount,
          discountAmount,
          finalPrice,
          order.couponCode || '-',
          getStatusText(order.status),
          formattedDateTime
        ]);
      });

      // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      wsData.push([]);
      wsData.push([
        '',
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ',
        '',
        '',
        `${totalOrders} Ø·Ù„Ø¨`,
        totalQuantity,
        '',
        totalRevenue + totalDiscounts,
        totalDiscounts,
        totalRevenue,
        '',
        '',
        `ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${(totalRevenue - totalDiscounts).toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡`
      ]);

      // Ø¥Ù†Ø´Ø§Ø¡ worksheet
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø©
      const colWidths = [
        { wch: 5 },  // Ù…
        { wch: 20 }, // Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
        { wch: 15 }, // Ø§Ù„Ù‡Ø§ØªÙ
        { wch: 40 }, // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        { wch: 30 }, // Ø§Ù„Ù…Ù†ØªØ¬
        { wch: 8 },  // Ø§Ù„ÙƒÙ…ÙŠØ©
        { wch: 12 }, // Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©
        { wch: 15 }, // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙ…
        { wch: 12 }, // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®ØµÙ…
        { wch: 15 }, // Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        { wch: 15 }, // ÙƒÙˆØ¯ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†
        { wch: 12 }, // Ø§Ù„Ø­Ø§Ù„Ø©
        { wch: 20 }  // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
      ];
      ws['!cols'] = colWidths;

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
      const range = XLSX.utils.decode_range(ws['!ref']);

      // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„)
      if (ws['A1']) {
        ws['A1'].s = {
          font: { bold: true, sz: 16, color: { rgb: "FFFFFF" } },
          fill: { fgColor: { rgb: "4F46E5" } },
          alignment: { horizontal: "center", vertical: "center" }
        };
      }

      // ØªÙ†Ø³ÙŠÙ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ± (Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ)
      if (ws['A2']) {
        ws['A2'].s = {
          font: { sz: 12, color: { rgb: "666666" } },
          alignment: { horizontal: "center" }
        };
      }

      // ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ğŸ“Š Ùˆ ğŸ“ˆ Ùˆ ğŸ“‹)
      for (let R = range.s.r; R <= range.e.r; ++R) {
        const cellRef = XLSX.utils.encode_cell({ r: R, c: 0 });
        if (ws[cellRef] && ws[cellRef].v && typeof ws[cellRef].v === 'string') {
          if (ws[cellRef].v.includes('ğŸ“Š') || ws[cellRef].v.includes('ğŸ“ˆ') || ws[cellRef].v.includes('ğŸ“‹')) {
            ws[cellRef].s = {
              font: { bold: true, sz: 14, color: { rgb: "FFFFFF" } },
              fill: { fgColor: { rgb: "059669" } },
              alignment: { horizontal: "center", vertical: "center" }
            };
          }
        }
      }

      // ØªÙ†Ø³ÙŠÙ‚ Ø±Ø£Ø³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      const headerRowIndex = wsData.findIndex(row => row[0] === 'Ù…');
      if (headerRowIndex !== -1) {
        for (let C = 0; C <= 12; ++C) {
          const cellRef = XLSX.utils.encode_cell({ r: headerRowIndex, c: C });
          if (ws[cellRef]) {
            ws[cellRef].s = {
              font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
              fill: { fgColor: { rgb: "2563EB" } }, // Ø£Ø²Ø±Ù‚ Ø£Ø¬Ù…Ù„
              alignment: { horizontal: "center", vertical: "center" },
              border: {
                top: { style: "medium", color: { rgb: "000000" } },
                bottom: { style: "medium", color: { rgb: "000000" } },
                left: { style: "thin", color: { rgb: "000000" } },
                right: { style: "thin", color: { rgb: "000000" } }
              }
            };
          }
        }
      }

      // ØªÙ†Ø³ÙŠÙ‚ ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const dataStartRow = headerRowIndex + 1;
      for (let R = dataStartRow; R < wsData.length - 2; ++R) {
        const isEvenRow = (R - dataStartRow) % 2 === 0;
        const bgColor = isEvenRow ? "F8FAFC" : "FFFFFF";

        for (let C = 0; C <= 12; ++C) {
          const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
          if (ws[cellRef]) {
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let alignment = "right";
            if (C === 0 || C === 5 || C === 11) alignment = "center"; // Ù…ØŒ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ø§Ù„Ø­Ø§Ù„Ø©
            if (C >= 6 && C <= 9) alignment = "center"; // Ø§Ù„Ø£Ø³Ø¹Ø§Ø±

            ws[cellRef].s = {
              fill: { fgColor: { rgb: bgColor } },
              alignment: {
                horizontal: alignment,
                vertical: "center"
              },
              border: {
                top: { style: "thin", color: { rgb: "E2E8F0" } },
                bottom: { style: "thin", color: { rgb: "E2E8F0" } },
                left: { style: "thin", color: { rgb: "E2E8F0" } },
                right: { style: "thin", color: { rgb: "E2E8F0" } }
              },
              font: { sz: 11 }
            };

            // ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            if (C >= 6 && C <= 9) {
              ws[cellRef].s.numFmt = '#,##0" Ø¬Ù†ÙŠÙ‡"';
              ws[cellRef].s.font = { sz: 11, bold: true };
            }

            // ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø­Ø§Ù„Ø©
            if (C === 11) {
              const status = ws[cellRef].v;
              if (status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…') {
                ws[cellRef].s.fill = { fgColor: { rgb: "DCFCE7" } };
                ws[cellRef].s.font = { sz: 11, bold: true, color: { rgb: "166534" } };
              } else if (status === 'ØªÙ… Ø§Ù„Ø´Ø­Ù†') {
                ws[cellRef].s.fill = { fgColor: { rgb: "DBEAFE" } };
                ws[cellRef].s.font = { sz: 11, bold: true, color: { rgb: "1D4ED8" } };
              } else if (status === 'Ù…Ø¤ÙƒØ¯') {
                ws[cellRef].s.fill = { fgColor: { rgb: "FEF3C7" } };
                ws[cellRef].s.font = { sz: 11, bold: true, color: { rgb: "D97706" } };
              } else if (status === 'Ù…Ù„ØºÙŠ') {
                ws[cellRef].s.fill = { fgColor: { rgb: "FEE2E2" } };
                ws[cellRef].s.font = { sz: 11, bold: true, color: { rgb: "DC2626" } };
              }
            }
          }
        }
      }

      // ØªÙ†Ø³ÙŠÙ‚ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
      const totalRowIndex = wsData.length - 1;
      for (let C = 0; C <= 12; ++C) {
        const cellRef = XLSX.utils.encode_cell({ r: totalRowIndex, c: C });
        if (ws[cellRef]) {
          ws[cellRef].s = {
            font: { bold: true, color: { rgb: "FFFFFF" }, sz: 12 },
            fill: { fgColor: { rgb: "059669" } }, // Ø£Ø®Ø¶Ø± Ø¬Ù…ÙŠÙ„
            alignment: { horizontal: "center", vertical: "center" },
            border: {
              top: { style: "thick", color: { rgb: "000000" } },
              bottom: { style: "thick", color: { rgb: "000000" } },
              left: { style: "medium", color: { rgb: "000000" } },
              right: { style: "medium", color: { rgb: "000000" } }
            }
          };

          // ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ ØµÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          if (C >= 7 && C <= 9) {
            ws[cellRef].s.numFmt = '#,##0" Ø¬Ù†ÙŠÙ‡"';
          }
        }
      }

      // Ø¥Ø¶Ø§ÙØ© worksheet Ø¥Ù„Ù‰ workbook
      XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª');

      // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
      const fileName = `AQRAB_Orders_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);

      showNotification(`ØªÙ… ØªØµØ¯ÙŠØ± ${totalOrders} Ø·Ù„Ø¨ Ø¨Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalRevenue.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡`, "success");

    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±:", error);
      showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±", "error");
    }
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ±Ø¬Ù…Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  function getStatusText(status) {
    const statusMap = {
      'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
      'confirmed': 'Ù…Ø¤ÙƒØ¯',
      'shipped': 'ØªÙ… Ø§Ù„Ø´Ø­Ù†',
      'delivered': 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
      'cancelled': 'Ù…Ù„ØºÙŠ'
    };
    return statusMap[status] || 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
  }



  // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  function updateStats(orders) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const totalOrders = orders.length;
    const todayOrders = orders.filter(order => {
      const orderDate = new Date(order.date);
      orderDate.setHours(0, 0, 0, 0);
      return orderDate.getTime() === today.getTime();
    }).length;

    const pendingOrders = orders.filter(order => order.status === 'pending').length;
    const completedOrders = orders.filter(order => order.status === 'delivered' || order.status === 'received').length;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ±
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('todayOrders').textContent = todayOrders;
    document.getElementById('pendingOrders').textContent = pendingOrders;
    document.getElementById('completedOrders').textContent = completedOrders;
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± (Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ø°ÙƒÙŠ)
  async function updateVisitorCount() {
    console.log("ğŸ“Š Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù„ Ø§Ù„Ø¨Ø¯ÙŠÙ„...");

    try {
      // Ø§Ù„Ø­Ù„ Ø§Ù„Ø¨Ø¯ÙŠÙ„: Ø­Ø³Ø§Ø¨ Ø§Ù„Ø²ÙˆØ§Ø± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø°ÙƒÙŠØ©
      const ordersSnapshot = await getDocs(collection(db, "orders"));
      const uniquePhones = new Set();
      const ordersByDate = new Map();
      let totalOrders = 0;

      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        totalOrders++;

        if (order.phone) {
          uniquePhones.add(order.phone);
        }

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (order.date) {
          const orderDate = new Date(order.date).toDateString();
          if (!ordersByDate.has(orderDate)) {
            ordersByDate.set(orderDate, 0);
          }
          ordersByDate.set(orderDate, ordersByDate.get(orderDate) + 1);
        }
      });

      // Ø­Ø³Ø§Ø¨ ØªÙ‚Ø¯ÙŠØ± Ø°ÙƒÙŠ Ù„Ù„Ø²ÙˆØ§Ø±
      const uniqueCustomers = uniquePhones.size;
      const averageOrdersPerDay = ordersByDate.size > 0 ? totalOrders / ordersByDate.size : 1;
      const conversionRate = uniqueCustomers > 0 ? (totalOrders / uniqueCustomers) : 1;

      // ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
      let estimatedVisitors;
      if (conversionRate > 0.1) {
        // Ù…Ø¹Ø¯Ù„ ØªØ­ÙˆÙŠÙ„ Ø¹Ø§Ù„ÙŠ - ØªÙ‚Ø¯ÙŠØ± Ù…Ø­Ø§ÙØ¸
        estimatedVisitors = Math.round(uniqueCustomers * 4);
      } else if (conversionRate > 0.05) {
        // Ù…Ø¹Ø¯Ù„ ØªØ­ÙˆÙŠÙ„ Ù…ØªÙˆØ³Ø·
        estimatedVisitors = Math.round(uniqueCustomers * 6);
      } else {
        // Ù…Ø¹Ø¯Ù„ ØªØ­ÙˆÙŠÙ„ Ù…Ù†Ø®ÙØ¶ - ØªÙ‚Ø¯ÙŠØ± Ø£Ø¹Ù„Ù‰
        estimatedVisitors = Math.round(uniqueCustomers * 10);
      }

      // Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø¯ÙŠØ± Ù„Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ·Ù„Ø¨ÙˆØ§
      estimatedVisitors += Math.round(averageOrdersPerDay * ordersByDate.size * 2);

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      document.getElementById('totalVisitors').textContent = `~${estimatedVisitors}`;
      document.getElementById('totalVisitors').title = `ØªÙ‚Ø¯ÙŠØ± Ø°ÙƒÙŠ: ${uniqueCustomers} Ø¹Ù…ÙŠÙ„ ÙØ±ÙŠØ¯ØŒ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${(conversionRate * 100).toFixed(1)}%`;

      console.log("ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙˆØ§Ø±:");
      console.log(`- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ÙØ±ÙŠØ¯ÙˆÙ†: ${uniqueCustomers}`);
      console.log(`- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${totalOrders}`);
      console.log(`- Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${(conversionRate * 100).toFixed(1)}%`);
      console.log(`- ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø²ÙˆØ§Ø±: ${estimatedVisitors}`);

    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±:", error);
      hasPermissionIssues = true;
      document.getElementById('totalVisitors').textContent = "ØºÙŠØ± Ù…ØªØ§Ø­";
      document.getElementById('totalVisitors').className = "text-3xl font-bold text-gray-400";
      document.getElementById('totalVisitors').title = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±";
      showPermissionsAlert();
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ØªØ§Ø­)
  async function updateReturnsCount() {
    try {
      const querySnapshot = await getDocs(collection(db, "returns"));
      const totalReturns = querySnapshot.size;
      document.getElementById('totalReturns').textContent = totalReturns;
      console.log("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:", totalReturns);

      // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­
      const returnsTab = document.getElementById('returnsTab');
      if (returnsTab) {
        returnsTab.style.display = 'flex';
      }

    } catch (error) {
      console.warn("âš ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­ - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù…");

      // Ø¥Ø®ÙØ§Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
      const returnsCard = document.querySelector('[data-card="returns"]');
      if (returnsCard) {
        returnsCard.style.display = 'none';
      }

      // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ù† Ø§Ù„ØªÙ†Ù‚Ù„
      const returnsTab = document.getElementById('returnsTab');
      if (returnsTab) {
        returnsTab.style.display = 'none';
      }

      // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      const returnsSection = document.getElementById('returnsSection');
      if (returnsSection) {
        returnsSection.style.display = 'none';
      }

      console.log("ğŸ”’ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª");
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
  async function loadReturns() {
    const tbody = document.getElementById("returnsTable");

    tbody.innerHTML = `
      <tr>
        <td colspan="8" class="py-8 text-center text-gray-500">
          <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
          <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </td>
      </tr>
    `;

    try {
      const querySnapshot = await getDocs(collection(db, "returns"));

      if (querySnapshot.empty) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="py-12 text-center text-gray-500">
              <i class="fa-solid fa-inbox text-4xl mb-4 text-gray-300"></i>
              <div class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
              <div class="text-sm">Ø³ØªØ¸Ù‡Ø± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù‡Ù†Ø§</div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = "";

      querySnapshot.forEach(docSnap => {
        const returnItem = docSnap.data();
        const returnDate = new Date(returnItem.returnDate);
        const formattedDate = returnDate.toLocaleDateString('ar-EG', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const statusColors = {
          'pending': 'bg-yellow-100 text-yellow-800',
          'approved': 'bg-green-100 text-green-800',
          'rejected': 'bg-red-100 text-red-800',
          'completed': 'bg-blue-100 text-blue-800'
        };

        const statusTranslations = {
          'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
          'approved': 'ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©',
          'rejected': 'Ù…Ø±ÙÙˆØ¶',
          'completed': 'Ù…ÙƒØªÙ…Ù„'
        };

        tbody.innerHTML += `
          <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
            <td class="py-4 px-6 text-right">
              <div class="font-medium">${returnItem.customerName || "-"}</div>
              <div class="text-xs text-gray-500">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${returnItem.orderId ? returnItem.orderId.substring(0, 8).toUpperCase() : "-"}</div>
            </td>
            <td class="py-4 px-6 text-center">
              <div class="font-medium">${returnItem.customerPhone || "-"}</div>
            </td>
            <td class="py-4 px-6 text-right">
              <div class="font-medium">${returnItem.productName || "-"}</div>
              <div class="text-xs text-gray-500">Ø§Ù„ÙƒÙ…ÙŠØ©: ${returnItem.quantity || 1}</div>
              ${returnItem.originalPrice ? `<div class="text-xs text-gray-500">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: ${returnItem.originalPrice} Ø¬Ù†ÙŠÙ‡</div>` : ''}
            </td>
            <td class="py-4 px-6 text-right">
              <div class="text-sm">${returnItem.returnReason || "-"}</div>
              ${returnItem.additionalDetails ? `<div class="text-xs text-gray-500 mt-1">${returnItem.additionalDetails}</div>` : ''}
            </td>
            <td class="py-4 px-6 text-center">
              <div class="font-medium">${returnItem.refundAmount || "0"} Ø¬Ù†ÙŠÙ‡</div>
            </td>
            <td class="py-4 px-6 text-center">
              <select class="return-status-dropdown ${statusColors[returnItem.status]} border border-gray-300 rounded-lg px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-red-500"
                      data-return-id="${docSnap.id}"
                      data-current-status="${returnItem.status}">
                <option value="pending" ${returnItem.status === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                <option value="approved" ${returnItem.status === 'approved' ? 'selected' : ''}>ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
                <option value="rejected" ${returnItem.status === 'rejected' ? 'selected' : ''}>Ù…Ø±ÙÙˆØ¶</option>
                <option value="completed" ${returnItem.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
              </select>
            </td>
            <td class="py-4 px-6 text-center">
              <div class="text-sm text-gray-600">${formattedDate}</div>
            </td>
            <td class="py-4 px-6 text-center">
              <div class="flex gap-1 justify-center flex-wrap">
                <button class="view-return-details bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-medium transition flex items-center gap-1"
                        data-return='${JSON.stringify(returnItem)}'
                        data-return-id="${docSnap.id}">
                  <i class="fa-solid fa-eye"></i>
                  ØªÙØ§ØµÙŠÙ„
                </button>
                <button class="whatsapp-return-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs font-medium transition flex items-center gap-1"
                        data-phone="${returnItem.customerPhone}"
                        data-name="${returnItem.customerName}"
                        data-status="${returnItem.status}">
                  <i class="fa-brands fa-whatsapp"></i>
                  ÙˆØ§ØªØ³Ø§Ø¨
                </button>
                <button class="delete-return-btn bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-medium transition flex items-center gap-1"
                        data-id="${docSnap.id}">
                  <i class="fa-solid fa-trash"></i>
                  Ø­Ø°Ù
                </button>
              </div>
            </td>
          </tr>
        `;
      });

      // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
      activateReturnButtons();

    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª:", error);

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
      if (error.code === 'permission-denied') {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="py-12 text-center text-yellow-600">
              <i class="fa-solid fa-lock text-4xl mb-4"></i>
              <div class="text-lg font-medium">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</div>
              <div class="text-sm">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase</div>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="py-8 text-center text-red-500">
              <i class="fa-solid fa-exclamation-triangle text-2xl mb-2"></i>
              <div>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
              <div class="text-sm">${error.message}</div>
            </td>
          </tr>
        `;
      }
    }
  }

  // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
  function activateReturnButtons() {
    // Ø£Ø²Ø±Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    document.querySelectorAll(".view-return-details").forEach(btn => {
      btn.addEventListener("click", () => {
        const returnData = JSON.parse(btn.getAttribute("data-return"));
        const returnId = btn.getAttribute("data-return-id");
        showReturnDetails(returnData, returnId);
      });
    });

    // Ø£Ø²Ø±Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
    document.querySelectorAll(".whatsapp-return-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const phone = btn.getAttribute("data-phone");
        const name = btn.getAttribute("data-name");
        const status = btn.getAttribute("data-status");

        let message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}ØŒ Ø¨Ø®ØµÙˆØµ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† AQRAB.`;

        switch(status) {
          case 'pending':
            message += ' Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ³Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.';
            break;
          case 'approved':
            message += ' ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹. Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯.';
            break;
          case 'rejected':
            message += ' Ù†Ø£Ø³ÙØŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹. Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§.';
            break;
          case 'completed':
            message += ' ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.';
            break;
        }

        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/${phone.replace('+', '')}?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
      });
    });

    // Ø£Ø²Ø±Ø§Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
    document.querySelectorAll(".delete-return-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ØŸ")) {
          try {
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...';
            btn.disabled = true;

            await deleteDoc(doc(db, "returns", btn.getAttribute("data-id")));

            showNotification("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
            loadReturns();
          } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù", "error");
            btn.innerHTML = '<i class="fa-solid fa-trash"></i> Ø­Ø°Ù';
            btn.disabled = false;
          }
        }
      });
    });

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹
    document.querySelectorAll(".return-status-dropdown").forEach(dropdown => {
      dropdown.addEventListener("change", async (e) => {
        const returnId = e.target.getAttribute("data-return-id");
        const newStatus = e.target.value;
        const currentStatus = e.target.getAttribute("data-current-status");

        if (newStatus !== currentStatus) {
          try {
            await updateDoc(doc(db, "returns", returnId), {
              status: newStatus
            });

            e.target.setAttribute("data-current-status", newStatus);
            showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ø¨Ù†Ø¬Ø§Ø­", "success");
          } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©:", error);
            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "error");
            e.target.value = currentStatus;
          }
        }
      });
    });
  }

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹
  function showReturnDetails(returnData, returnId) {
    const modal = document.getElementById('returnDetailsModal');
    const content = document.getElementById('returnDetailsContent');

    const returnDate = new Date(returnData.returnDate);
    const orderDate = returnData.orderDate ? new Date(returnData.orderDate) : null;

    content.innerHTML = `
      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <h4 class="font-semibold text-gray-900 border-b pb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h4>
          <div>
            <label class="text-sm text-gray-600">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <p class="font-medium">${returnData.customerName || "-"}</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
            <p class="font-medium">${returnData.customerPhone || "-"}</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠ:</label>
            <p class="font-medium">${returnData.orderId ? returnData.orderId.substring(0, 8).toUpperCase() : "-"}</p>
          </div>
        </div>

        <div class="space-y-4">
          <h4 class="font-semibold text-gray-900 border-b pb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h4>
          <div>
            <label class="text-sm text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label>
            <p class="font-medium">${returnData.productName || "-"}</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
            <p class="font-medium">${returnData.quantity || 1}</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ:</label>
            <p class="font-medium">${returnData.originalPrice || "-"} Ø¬Ù†ÙŠÙ‡</p>
          </div>
        </div>
      </div>

      <div class="mt-6 space-y-4">
        <h4 class="font-semibold text-gray-900 border-b pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</h4>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-600">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</label>
            <p class="font-medium">${returnData.returnReason || "-"}</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
            <p class="font-medium">${returnData.refundAmount || "0"} Ø¬Ù†ÙŠÙ‡</p>
          </div>
          <div>
            <label class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:</label>
            <p class="font-medium">${returnDate.toLocaleDateString('ar-EG', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}</p>
          </div>
          ${orderDate ? `
          <div>
            <label class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠ:</label>
            <p class="font-medium">${orderDate.toLocaleDateString('ar-EG', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}</p>
          </div>
          ` : ''}
        </div>

        ${returnData.additionalDetails ? `
        <div>
          <label class="text-sm text-gray-600">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©:</label>
          <p class="bg-gray-50 p-3 rounded-lg">${returnData.additionalDetails}</p>
        </div>
        ` : ''}

        <div>
          <label class="text-sm text-gray-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</label>
          <textarea id="adminNotesInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...">${returnData.adminNotes || ''}</textarea>
        </div>
      </div>
    `;

    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
    modal.setAttribute('data-return-id', returnId);
    modal.classList.remove('hidden');
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
  document.getElementById('closeReturnDetails')?.addEventListener('click', () => {
    document.getElementById('returnDetailsModal').classList.add('hidden');
  });

  document.getElementById('closeReturnDetailsBtn')?.addEventListener('click', () => {
    document.getElementById('returnDetailsModal').classList.add('hidden');
  });

  // Ø­ÙØ¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  document.getElementById('updateReturnNotes')?.addEventListener('click', async () => {
    const modal = document.getElementById('returnDetailsModal');
    const returnId = modal.getAttribute('data-return-id');
    const adminNotes = document.getElementById('adminNotesInput').value;

    try {
      await updateDoc(doc(db, "returns", returnId), {
        adminNotes: adminNotes
      });

      showNotification("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
      modal.classList.add('hidden');
      loadReturns(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:", error);
      showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª", "error");
    }
  });

  // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.getElementById('returnsTab')?.addEventListener('click', async () => {
    // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    document.getElementById('ordersSection').style.display = 'none';
    // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
    document.getElementById('returnsSection').classList.remove('hidden');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
    await loadReturns();
  });

  // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  document.getElementById('backToOrders')?.addEventListener('click', () => {
    document.getElementById('returnsSection').classList.add('hidden');
    document.getElementById('ordersSection').style.display = 'block';
  });

  // Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
  document.getElementById('refreshReturns')?.addEventListener('click', () => {
    loadReturns();
  });

  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
  document.getElementById('searchReturns')?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#returnsTable tr');

    rows.forEach(row => {
      if (row.querySelector('td')) { // ØªØ¬Ø§Ù‡Ù„ header row
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  });

  // Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  document.getElementById('refreshOrders')?.addEventListener('click', () => {
    loadOrders();
  });

  // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase().trim();
    const rows = document.querySelectorAll('#ordersTable tr');

    rows.forEach(row => {
      if (row.querySelector('td')) { // ØªØ¬Ø§Ù‡Ù„ ØµÙ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  });

  // Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  document.getElementById('exportData')?.addEventListener('click', () => {
    exportData();
  });



  // Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  document.getElementById('notificationBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('notificationBtn');
    const icon = btn.querySelector('i');
    const text = btn.querySelector('span');

    // ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    icon.className = 'fa-solid fa-spinner fa-spin';
    if (text) text.textContent = 'Ø¬Ø§Ø±ÙŠ...';

    const granted = await requestNotificationPermission();

    // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    setTimeout(() => {
      if (granted) {
        icon.className = 'fa-solid fa-bell';
        btn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2';
        btn.title = 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø©';
        if (text) text.textContent = 'Ù…ÙØ¹Ù„';
      } else {
        icon.className = 'fa-solid fa-bell-slash';
        btn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-medium transition-all duration-300 hover:scale-105 flex items-center gap-2';
        btn.title = 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹Ø·Ù„Ø©';
        if (text) text.textContent = 'Ù…Ø¹Ø·Ù„';
      }
    }, 500);
  });

  // Event listeners Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ

  // Ø²Ø± Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  document.getElementById('saveProductSettings')?.addEventListener('click', saveProductSettings);

  // Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
  document.getElementById('refreshFinancials')?.addEventListener('click', calculateFinancialStats);

  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±Ø¨Ø­ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…
  ['productCost', 'productPrice', 'shippingCost', 'additionalCosts'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateProfitPreview);
  });

  // Ø¯Ù…Ø¬ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø¹ loadOrders
  const originalLoadOrders = loadOrders;
  loadOrders = async function() {
    try {
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
      await originalLoadOrders();

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
      const querySnapshot = await getDocs(collection(db, "orders"));
      const orders = [];
      querySnapshot.forEach((doc) => {
        orders.push(doc.data());
      });
      updateStats(orders);

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
      calculateFinancialStats();

      console.log("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­");

    } catch (error) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø´ÙƒÙ„Ø© ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©
      if (error.code === 'permission-denied') {
        console.warn("ğŸ”’ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        showPermissionsAlert();
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ù…Ù†ÙØµÙ„Ø© Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª)
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    try {
      await updateVisitorCount();
    } catch (error) {
      console.warn("ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±");
    }

    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)
    try {
      await updateReturnsCount();
    } catch (error) {
      console.warn("ØªØ­Ø°ÙŠØ±: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª");
      // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ø°ÙŠØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª
      const returnsTabWarning = document.getElementById('returnsTabWarning');
      if (returnsTabWarning) {
        returnsTabWarning.classList.remove('hidden');
        returnsTabWarning.title = "Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª";
      }
    }
  };

  // Auto refresh every 30 seconds
  setInterval(loadOrders, 30000);

  // Initial load
  loadOrders();

</script>

  </div> <!-- End of mainContent -->

</body>
</html>
